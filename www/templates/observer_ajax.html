{# Observer Location input template #}

{% extends "base.html" %}

{% block scripts %}

  <script type="text/javascript">

    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    $(document).ready(function() {

      $( "#_date" ).datepicker({ dateFormat: $.datepicker.ISO_8601 });

      $("#set_location").click(function(e) {
        {# astronomy.js uses document.getElementById #}
	astronomy.setLocation("_latitude", "_longitude", "_timezone", e);
      });


      $("#set_time").click(function(e) {
        var now = new Date();
        {# TODO pad time with leading 0s #}
        var time_str = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
        $("#_time").val(time_str);
      });


      $("#_longitude").change(function() {
        var timezone = Math.floor((parseFloat($("#_longitude").val()) + 7.5) / 15.0);
        $("#_timezone").val(timezone);
      });


      $("#get_sun_position").click(function(e) {

	$.getJSON($SCRIPT_ROOT + "/get_sun_position_ajax",
	  {
	    latitude: $('input[name="latitude"]').val(),
	    longitude: $('input[name="longitude"]').val(),
	    date: $('input[name="date"]').val(),
	    time: $('input[name="time"]').val(),
	    timezone: $('input[name="timezone"]').val(),
	    dst: $("#_dst").is(':checked') {# jQuery selector #}

	  },
	  function(data) {

            if ("error" in data) {

              alert("Error: " + data.error);

              $("#rising").text("TBD");
	      $("#transit").text("TBD");
	      $("#setting").text("TBD");
	      $("#azimuth").text("TBD");
	      $("#altitude").text("TBD");

            } else {

              $("#rising").text(data.rising);
	      $("#transit").text(data.transit);
	      $("#setting").text(data.setting);
	      $("#azimuth").text(data.azimuth);
	      $("#altitude").text(data.altitude);
            };

	  });

	return false;

      });


    }); {# end ready method #}


  </script>

{% endblock %}

{% block title %} Astronomical Algorithms Implemented {% endblock %}

{% block content %}

<h1>Flask AJAX and jQuery Pattern</h1>

<p>
Enter the observer's location in space and time and the get sun
position button will update the current page with the sun's position.
Timezone is estimated from the longitude, but should be adjusted as
needed.
</p>


  <table>

    <tr>

      <th>
	<button type="button" id="set_location">set location</button>
      </th>

      <th>Latitude</th>

      <td>
	<input type="text" id="_latitude" name="latitude">
      </td>

      <td>deg:min:sec</td>

    </tr>


    <tr>
      <th></th>

      <th>Longitude</th>

      <td>
	<input type="text" id="_longitude" name="longitude">
      </td>

      <td>deg:min:sec</td>

    </tr>


    <tr>
      <td></td>

      <th>Date</th>

      <td>
        <input type="text" id="_date" name="date"> {# id needed for date picker, name for form #}
      </td>

      <td>year-mm-dd</td>

    </tr>

    <tr>

      <th>
	<button id="set_time">set time</button>
      </th>

      <th>Local Time</th>

      <td><input type="text" id="_time" name="time" value="12:00"></td>

      <td>hr(24):min:sec</td>

    </tr>

    <tr>
      <td></td>

      <th>Time Zone</th>
      <td><input type="text" id="_timezone" name="timezone" value="0"></td>
      <td>hr</td>
    </tr>


    <tr>
      <td></td>
      <th>Daylight Savings</th>
      <td>
	<input type="checkbox" id="_dst" name="dst">
      </td>
    </tr>


    <tr>

      <th>
	<button id="get_sun_position">get sun position</button>
      </th>


    </tr>

    <tr>
      <th>Azimuth</th>
      <td id="azimuth" colspan="2">TBD</td>
      <td>deg:min:sec (deg)</td>
    </tr>

    <tr>
      <th>Altitude</th>
      <td id="altitude" colspan="2">TBD</td>
      <td>deg:min:sec (deg)</td>
    </tr>

    <tr>
      <th>Rising</th>
      <td id="rising" colspan="2">TBD</td>
      <td>ISO8601</td>
    </tr>


    <tr>
      <th>Transit</th>
      <td id="transit" colspan="2">TBD</td>
      <td>ISO8601</td>
    </tr>

    <tr>
      <th>Setting</th>
      <td id="setting" colspan="2">TBD</td>
      <td>ISO8601</td>
    </tr>

  </table>


<hr>


<p>

<a href="https://github.com/lrmcfarland/Astronomy/blob/master/www/templates/observer_ajax.html">
This
</a>
is an example of the
<a href="http://flask.pocoo.org/docs/0.10/patterns/jquery/">flask
AJAX with jQuery pattern</a>.

</p>

<p>
Observer data are read from the observer's input elements by id and sent as a
JSON get query to the get_sun_position page on the server as a button click
event:
</p>

<pre>
	$.getJSON($SCRIPT_ROOT + "/get_sun_position_ajax",
	  {
	    latitude: $('input[name="latitude"]').val(),
	    longitude: $('input[name="longitude"]').val(),
	    date: $('input[name="date"]').val(),
	    time: $('input[name="time"]').val(),
	    timezone: $('input[name="timezone"]').val(),
	    dst: $("#_dst").is(':checked') {# jQuery selector #}

	  },
	  function(data) {

            if ("error" in data) {

              alert("Error: " + data.error);

              $("#rising").text("TBD");
	      $("#transit").text("TBD");
	      $("#setting").text("TBD");
	      $("#azimuth").text("TBD");
	      $("#altitude").text("TBD");

            } else {

              $("#rising").text(data.rising);
	      $("#transit").text(data.transit);
	      $("#setting").text(data.setting);
	      $("#azimuth").text(data.azimuth);
	      $("#altitude").text(data.altitude);
            };

	  });

</pre>

<p>
On the
 <a href="https://github.com/lrmcfarland/Astronomy/blob/master/www/astronomy.py">astronomy.py</a>
side, this is read in from the flask request args and the results are returned as a JSON string
</p>

<pre>
@app.route("/get_sun_position_ajax")
def get_sun_position_ajax():
    """Get sun position

    This was written to handle a JQuery AJAX call to connect a button
    click event to send a get request with parameters for:

    latitude, longitude, date, time timezone, dst

    The server does calculation and return the sun position data as a
    JSON object.

    If there is an exception, this returns an error key with the
    message as the value in the same JSON object. The caller is
    expected to handle it as they see fit.
    """

    try:

        # TODO difference in template ajax input :checked selector and form
        if flask.request.args.get('dst') == 'true':
            is_dst = True
        else:
            is_dst = False

        result = calculate_sun_position(request_angle('latitude'),
                                        request_angle('longitude'),
                                        request_datetime('date',
                                                         'time',
                                                         request_float('timezone'),
                                                         is_dst),
                                        is_dst)

    except (ValueError, RuntimeError) as err:

        app.logger.error(err)
        result = {'error': str(err)}

    return flask.jsonify(**result)

</pre>

<p>
  The results are then used to update the display.
</p>



{% endblock %}
