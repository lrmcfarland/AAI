{# AAI daily solar altitude chart #}

{% extends "base.html" %}

{% block scripts %}

  <script type="text/javascript">

    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    {# -------------------- #}
    {# ----- init map ----- #}
    {# -------------------- #}


    {# ----- draw chart ----- #}


    google.charts.load('current', {'packages':['corechart']});

    function updateSunChart(sun_position_data) {

	if (sun_position_data.errors.length > 0) {

	    $("#rising").text("TBD");
	    $("#transit").text("TBD");
	    $("#setting").text("TBD");
	    $("#azimuth").text("TBD");
	    $("#altitude").text("TBD");

	    alert("Errors: " + sun_position_data.errors.join(", "));

	} else {

	    $("#rising").text(sun_position_data.rising);
	    $("#transit").text(sun_position_data.transit);
	    $("#setting").text(sun_position_data.setting);
	    $("#azimuth").text(sun_position_data.sun_marker_azimuth);
	    $("#altitude").text(sun_position_data.sun_marker_altitude);


	    $('input[name="latitude"]').val(sun_position_data.latitude);
	    $('input[name="longitude"]').val(sun_position_data.longitude);


	    {# TODO meh! use regex #}
	    var a_datetime = sun_position_data.datetime.split('T');
	    var a_timeandzone = [a_datetime[1], 0];
	    var a_sign = '';

	    if (/-/.test(a_datetime[1])) {

		a_timeandzone = a_datetime[1].split('-');
		a_sign = '-';

	    } else if (/\+/.test(a_datetime[1])) {

		a_timeandzone = a_datetime[1].split('+');
		a_sign = '+';

	    } else {
		{# pass #}
	    }

	    $('input[name="date"]').val(a_datetime[0]);

	    $('input[name="time"]').val(a_timeandzone[0]);
	    $('input[name="timezone"]').val(a_sign + a_timeandzone[1]);


	    drawSunChart(sun_position_data);
	};

    }; {# end updateSunChart(sun_position_data) #}


    function drawSunChart(sun_position_data) {

	{# ----- formatting for google chart ----- #}
	var sun_plot_data = [['time',
			      'Vernal Equinox',
			      'Summer Solstice',
			      'Autumnal Equinox',
			      'Winter Solstice',
			      sun_position_data.sun_date_label,
			      {'type': 'string', 'role': 'style'}]];

	{# ----- special format for sun marker ----- #}

	for (var i = 0; i < sun_position_data.altitude_data_24h.length - 1; i++) {

	    var plot_record = sun_position_data.altitude_data_24h[i];
	    var next_plot_record = sun_position_data.altitude_data_24h[i+1];

	    if (sun_position_data.sun_marker_time == plot_record[0]) {

		plot_record.push('point { size: 18; shape-type: circle; fill-color: #FFD700; }');

	    } else if (sun_position_data.sun_marker_time > plot_record[0] &&
		       sun_position_data.sun_marker_time < next_plot_record[0]) {

		plot_record.push('point { size: 18; shape-type: circle; fill-color: #FFD700; }');

	    } else if (i == sun_position_data.altitude_data_24h.length - 1 &&
		       sun_position_data.sun_marker_time == next_plot_record[0]) {

		plot_record.push('point { size: 18; shape-type: circle; fill-color: #FFD700; }');

	    } else if (sun_position_data.sun_marker_time > next_plot_record[0]) {

		plot_record.push(null);

	    } else {

		plot_record.push(null);

	    }


	    sun_plot_data.push(plot_record);

	}

	var altitudeVtime_chart = new google.visualization.LineChart(
	    document.getElementById('altitudeVtime'));

	var altitude_table = google.visualization.arrayToDataTable(sun_plot_data);
	var altitude_view = getSunChartView(altitude_table, "Altitude over time for one day", "hour");

	altitudeVtime_chart.draw(altitude_view.data, altitude_view.options);

	{# ----- make toggles active ----- #}

	$("#_vernal_equinox_cb").change(function() {
	  var altitude_view = getSunChartView(altitude_table);
	  altitudeVtime_chart.draw(altitude_view.data, altitude_view.options);
	});

	$("#_summer_solstice_cb").change(function() {
	  var altitude_view = getSunChartView(altitude_table);
	  altitudeVtime_chart.draw(altitude_view.data, altitude_view.options);
	});

	$("#_autumnal_equinox_cb").change(function() {
	  var altitude_view = getSunChartView(altitude_table);
	  altitudeVtime_chart.draw(altitude_view.data, altitude_view.options);
	});

	$("#_winter_solstice_cb").change(function() {
	  var altitude_view = getSunChartView(altitude_table);
	  altitudeVtime_chart.draw(altitude_view.data, altitude_view.options);
	});


    }; {# end drawSunChart(sun_position_data) #}


    function getSunChartView (data_table, chart_title, hAxis_title) {

	var view_data = {};

	var current_color = "blue";
	var vernal_color = "green";
	var summer_color = "red";
	var autumnal_color = "orange";
	var winter_color = "cyan";


	var options = {

	    legend: "none",

	    chartArea: {left: "10%", top: "10%", width:"90%", height:"80%"},

	    title: chart_title,

	    hAxis: { title: hAxis_title},
	    vAxis: { title: "altitude in degrees above the horizon", minValue: -100, maxValue: 100},

	    series: {
		0: { lineDashStyle: [] }
	    },

	    colors: [current_color],

	    pointSize: 1,
	    dataOpacity: 0.7

	};


	var data = new google.visualization.DataView(data_table);

	var hides = [];
	var line_count = 0; {# assumes order ve, ss, ae, ws, current time #}

	if ($("#_vernal_equinox_cb").is(':checked')) {
	    options.series[line_count++] = { color: vernal_color, lineDashStyle: [4, 2] };
	} else {
	    hides.push(1);
	};


	if ($("#_summer_solstice_cb").is(':checked')) {
	    options.series[line_count++] = { color: summer_color, lineDashStyle: [8, 4] };
	} else {
	    hides.push(2);
	};


	if ($("#_autumnal_equinox_cb").is(':checked')) {
	    options.series[line_count++] = { color: autumnal_color, lineDashStyle: [16, 4] };
	} else {
	    hides.push(3);
	};


	if ($("#_winter_solstice_cb").is(':checked')) {
	    options.series[line_count++] = { color: winter_color, lineDashStyle: [32, 4] };
	} else {
	    hides.push(4);
	};

	data.hideColumns(hides);

	view_data['data'] = data;
	view_data['options'] = options;

	return view_data;

    };


    {# ----------------- #}
    {# ----- ready ----- #}
    {# ----------------- #}

    $(document).ready(function() {

	{# ----- get data ----- #}

	$("#get_daily_solar_altitude").click(function(e) {

	    $.getJSON($SCRIPT_ROOT + "/api/v1/daily_solar_altitude",
		      {
			  latitude: $('input[name="latitude"]').val(),
			  longitude: $('input[name="longitude"]').val(),
			  date: $('input[name="date"]').val(),
			  time: $('input[name="time"]').val(),
			  timezone: $('input[name="timezone"]').val(),
			  dst: $("#_dst").is(':checked') {# jQuery selector #}

		      },
		      function(sun_position) {

			  updateSunChart(sun_position);

		      }); {# end getJSON #}

	    return false;

	}); {# end get_daily_solar_altitude click #}



	$("#get_midnight_sun").click(function(e) {

	    $.getJSON($SCRIPT_ROOT + "/api/v1/daily_solar_altitude",
		      {
			  latitude: '66:33',
			  longitude: '0:0:0',
			  date: '2018-06-21',
			  time: '12:00:00',
			  timezone: '0',
			  dst: 'false'
		      },
		      function(sun_position) {

			  updateSunChart(sun_position);

		      }); {# end getJSON #}

	    return false;

	}); {# end get_midnight_sun click #}


	$("#get_darkness_at_noon").click(function(e) {

	    $.getJSON($SCRIPT_ROOT + "/api/v1/daily_solar_altitude",
		      {
			  latitude: '66:33',
			  longitude: '0:0:0',
			  date: '2018-12-21',
			  time: '12:00:00',
			  timezone: '0',
			  dst: 'false'
		      },
		      function(sun_position) {

			  updateSunChart(sun_position);

		      }); {# end getJSON #}

	    return false;

	}); {# end get_darkness_at_noon click #}


	$("#get_no_shadow_at_noon").click(function(e) {

	    $.getJSON($SCRIPT_ROOT + "/api/v1/daily_solar_altitude",
		      {
			  latitude: '23:05',
			  longitude: '32:54',
			  date: '2018-06-21',
			  time: '12:00:00',
			  timezone: '2',
			  dst: 'false'
		      },
		      function(sun_position) {

			  updateSunChart(sun_position);

		      }); {# end getJSON #}

	    return false;

	}); {# end get_no_shadow_at_noon click #}



    }); {# end ready method #}


  </script>

{% endblock %}

{% block title %}Daily Solar Altitude{% endblock %}

{% block content %}

<style>

.page {
    width: 60em;
}

.linechart {
    width: 800px;
    height: 400px;
}

table#sun_chart_legend {
    width: 10em;
}

#_vernal_equinox_txt {
    color: green;
}

#_summer_solstice_txt {
    color: red;
}

#_autumnal_equinox_txt {
    color: orange;
}

#_winter_solstice_txt {
    color: cyan;
}


button#get_daily_solar_altitude {

    text-align: center;

    font-size: 100%;
    font-weight: bold;

    margin: 0 auto;
    display: block;

    width: 100px;
    height: 100px;

    border-radius: 50%;

    color:red;
    background: #ffD700;
}


</style>



<h1>Daily Solar Altitude</h1>

<br>

<div class="twocolumn">

    This shows the
    sun's <a href="https://en.wikipedia.org/wiki/Horizontal_coordinate_system">altitude</a>
    over the current day starting at local midnight. The points where
    the altitude crosses the zero line indicates sun rise and sun set
    (not adjusted for atmospheric refraction). The distance between
    them is the length of the day.  The solstice lines indicate the
    maximum and minimum range of the sun position through out the
    year.

    <p>

    The earth's <a href="https://en.wikipedia.org/wiki/Axial_tilt">axial tilt</a>
    is 23&deg;-ish so a <a href="https://en.wikipedia.org/wiki/Midnight_sun">midnight
      sun</a> happens at an extreme latitude, e.g. near the
    <a href="https://en.wikipedia.org/wiki/Polar_circle">polar
      circle</a>, for example
    <button id="get_midnight_sun">on the summer solstice at 66&deg;N</button>
    Conversly, it is darkness at noon at
    <button id="get_darkness_at_noon">on the winter solstice at 66&deg;N</button>.

    The well that "had no shadow at noon on the solstice"
    <a href="https://en.wikipedia.org/wiki/Eratosthenes#Measurement_of_the_Earth.27s_circumference">
      Eratosthenes uses to calculate the earth's circumference
    </a>
    <button id="get_no_shadow_at_noon">is 23&deg;N and on the summer solstice</button>.


</div>

<br>

{% include "observer_location.html" %}

<br>

<button id="get_daily_solar_altitude">get solar altitude data</button>

<h2>Daily Solar Altitude</h2>


<table>

  <tr>

    <td>
      <div id="altitudeVtime" class="linechart"></div>
    </td>

    <td>

      <table id="sun_chart_legend">

	<tr>

	  <td>
	    <input type="checkbox" id="_vernal_equinox_cb" name="vernal_equinox_cb">
	  </td>

	  <td id="_vernal_equinox_txt">
	    Vernal Equinox
	  </td>

	</tr>

	<tr>

	  <td>
	    <input type="checkbox" id="_summer_solstice_cb" name="summer_solstice_cb" checked>
	  </td>

	  <td id="_summer_solstice_txt">
	    Summer Solstice
	  </td>

	</tr>

	<tr>

	  <td>
	    <input type="checkbox" id="_autumnal_equinox_cb" name="autumnal_equinox_cb">
	  </td>

	  <td id="_autumnal_equinox_txt">
	    Autumnal Equinox
	  </td>

	</tr>

	<tr>

	  <td>
	    <input type="checkbox" id="_winter_solstice_cb" name="winter_solstice_cb" checked>
	  </td>

	  <td id="_winter_solstice_txt">
	    Winter Solstice
	  </td>

	</tr>


      </table>

    </td>

  </tr>

  <tr>
    <td colspan="2">

      <table id="results_table" align="center">

	<tr>
	  <th>Azimuth</th>
	  <td id="azimuth">TBD</td>
	  <td>deg:min:sec (deg)</td>
	</tr>

	<tr>
	  <th>Altitude</th>
	  <td id="altitude">TBD</td>
	  <td>deg:min:sec (deg)</td>
	</tr>

	<tr>
	  <th>Rising</th>
	  <td id="rising">TBD</td>
	  <td>ISO8601</td>
	</tr>


	<tr>
	  <th>Transit</th>
	  <td id="transit">TBD</td>
	  <td>ISO8601</td>
	</tr>

	<tr>
	  <th>Setting</th>
	  <td id="setting">TBD</td>
	  <td>ISO8601</td>
	</tr>

      </table>

    </td>
  </tr>

</table>

{% endblock %}
